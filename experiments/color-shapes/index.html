<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Color Shapes</title>
	<script src="js/d3/d3.min.js"></script>
	<script src="js/util.js"></script>
	<script src="js/Vec2.js"></script>
	<script src="js/Color.js"></script>

	<style>
		canvas {
			padding: 20px;
		}
	</style>
</head>
<body>
	
	<canvas id="canvas"></canvas>


	<script>

		

		var hl = hexLines(70);

		var text = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f"];
		var colorlist = [];
		var canvas = document.getElementById("canvas");
		canvas.width = 1200;
		canvas.height = 700;
		var ctx = canvas.getContext("2d");


		var et = 1000;
		var ct = Date.now();
		var pt = Date.now();
		var delay = 1000;
		var raf = window.requestAnimationFrame(loop);

		function loop() {
		 raf = window.requestAnimationFrame(loop);

			ct = Date.now();
			et += ct - pt;
			pt = ct;

			// console.log(ct + " | " + pt + " | " + et);

			if (et >= delay) {
				et = 0;
				color = Color().hex();
				colorlist.push(color);
				hexTextLoc = new Vec2(250, 100);
				draw(ctx, color, hl, hexTextLoc, loc, center);
			}
		}



		var loc = new Vec2(100,100);

		function queue() {
			raf = window.requestAnimationFrame(loop);
		}
		function dequeue() {
			window.cancelAnimationFrame(raf);
		}

		var running = true;
		window.addEventListener("click", function(e){
			if (running) dequeue();
			else queue();
			running = !running;
		});

		window.addEventListener("keydown", function(e){
			if (e.keyCode === 37) {
				// left arrow
				color = Color().hex();
				hexTextLoc = new Vec2(250, 100);
				draw(ctx, color, hl, hexTextLoc, loc, center);
			}
		})

		function draw(ctx, color, hexlist, hexTextLoc, legendLoc, startPoint) {
			console.log(color);
			resetCanvasMatrix(ctx);
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			ctx.fillStyle = color;
			ctx.font = "16px Helvetica";
			ctx.textBaseline = "middle";
			ctx.textAlign = "center";
			ctx.fillText(color, hexTextLoc.x, hexTextLoc.y);
			drawHexLegend(ctx, hexlist, legendLoc);
			drawDynamicPathHex(ctx, hexlist, color, startPoint);
		}

		var center = new Vec2(canvas.width/2, canvas.height/2-100);
		

		function drawHexLegend(ctx, hl, location) {
			var lines = d3.range(16);
			ctx.translate(location.x, location.y);
			ctx.strokeStyle = "rgba(0,0,0,0.3)";
			ctx.fillStyle = "rgba(0,0,0,0.4)";
			for (var i=0; i<lines.length; i++) {
				ctx.beginPath();
				var l = hl(i);
				var b = l.begin;
				var e = l.end;
				// console.log(l.color);
				// ctx.strokeStyle = l.color;
				var normLine = b.clone().add(Vec2.normWithAngle(e.clone().angle() - Math.PI/2).mag(11));
				var negNormLine = normLine.clone().scale(-1);
				
				ctx.lineTo(negNormLine.x, negNormLine.y);
				ctx.lineTo(e.x, e.y);
				ctx.lineTo(normLine.x, normLine.y);
				ctx.lineTo(0,0);
				// ctx.moveTo(b.x, b.y);
				// ctx.lineTo(e.x, e.y);

				var tvec = e.clone();
				var m = tvec.mag();
				tvec = tvec.mag(m*1.2);

				ctx.textBaseline = "middle"; 
				ctx.textAlign = "center"; 
				ctx.fillText(text[i], tvec.x, tvec.y);

				// ctx.stroke();
				ctx.fill();
				ctx.closePath();
			}
		}

		function drawDynamicPathHex(ctx, lines, hexString, initialPoint) {
			var absPoints = [];
			var current = initialPoint.clone();

			var color = hexString.toUpperCase();
			var string = hexString.substring(1);

			absPoints.push({ x: current.x, y: current.y });

			ctx.translate(initialPoint.x, initialPoint.y);

			var radius = 8;

			for (var i=0; i<string.length; i++) {
				ctx.beginPath();

				var digit = string[i];
				var line = lines(digit);

				// ctx.strokeStyle = "rgba(0,0,0,0.2)";//Color(color).a(0.2).toString();
				
				ctx.fillStyle = color;
				ctx.strokeStyle = "black";
				ctx.lineWidth = 3;
				ctx.arc(0, 0, radius, 0, 2*Math.PI);
				ctx.fill();
				ctx.lineWidth = 1;
				ctx.closePath();
				ctx.beginPath();

				// ctx.strokeStyle = Color(color).a(0.7).toString();
				ctx.strokeStyle = "rgba(0,0,0,0.4)";

				ctx.textBaseline = "middle"; 
				ctx.textAlign = "center"; 

				ctx.moveTo(0,0);

				var normLine = line.begin.clone().add(Vec2.normWithAngle(line.end.clone().angle() - Math.PI/2).mag(5));
				var negNormLine = normLine.clone().scale(-1);
				
				ctx.lineTo(negNormLine.x, negNormLine.y);
				ctx.lineTo(line.end.x, line.end.y);
				ctx.lineTo(normLine.x, normLine.y);
				ctx.lineTo(0,0);
				// ctx.stroke();
				ctx.fill();
				ctx.closePath();
				ctx.beginPath();

				var tvec = line.end.clone();
				var m = tvec.mag();
				tvec = tvec.mag(m * 0.5);
				var nvec = tvec.add(Vec2.normWithAngle(tvec.angle() + Math.PI/2).mag(15));
				// ctx.fillText(digit, nvec.x, nvec.y);

				ctx.translate(line.end.x, line.end.y);

				current = current.add(line.end.clone());

				absPoints.push({ x: current.x, y: current.y });

				ctx.stroke();
				ctx.fill();
				ctx.closePath();
			}

			ctx.beginPath();
			ctx.strokeStyle = "black";
			ctx.lineWidth = 3;
			// ctx.arc(0,0,radius,0,2*Math.PI);
			ctx.stroke();
			ctx.lineWidth = 1;
			ctx.fill();
			ctx.closePath();
			

			var xExtent = d3.extent(absPoints.map(function(m){ return m.x; }));
			var yExtent = d3.extent(absPoints.map(function(m){ return m.y; }));

			return [xExtent, yExtent];
		}

		

		function hexLines(scale) {
			var s = undefined ? 1 : scale;
			var n = 16;
			var lines = [];
			var begin = Vec2.zero();
			var angle = 2*Math.PI / n;
			var angleOffset = -Math.PI / 2;

			for (var i=0; i<n; i++) {
				var end = Vec2.normWithAngle(angle * i + angleOffset).mag(s);
				lines[i] = { begin: begin, end: end };
			}

			return function(i) {
				if (i >= 0 && i < n) i = i;
				else if (i === "a" || i === "A") i = 10;
				else if (i === "b" || i === "B") i = 11;
				else if (i === "c" || i === "C") i = 12;
				else if (i === "d" || i === "D") i = 13;
				else if (i === "e" || i === "E") i = 14;
				else if (i === "f" || i === "F") i = 15;
				else return null;

				return lines[i];
			};
		}


	</script>
</body>
</html>